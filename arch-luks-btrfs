#!/usr/bin/env bash

export MY_DISK=/dev/nvme0n1
export MY_ROOT=luksroot

# Assumes disks are partitioned

set -euo pipefail

# Check if any Wi-Fi interface is up
if ! ip link show | grep -q "wl.*state UP"; then
    echo "Wi-Fi interface not connected or not up."
    exit 1
fi

# Check if internet connectivity works
if ! ping -q -c 1 -W 2 8.8.8.8 >/dev/null 2>&1; then
    echo "No internet connectivity."
    exit 1
fi

# Check NVMe partition layout
if [[ ! -b /dev/nvme0n1 ]]; then
    echo "/dev/nvme0n1 not found."
    exit 1
fi

PART_COUNT=$(lsblk -no NAME /dev/nvme0n1 | grep -c '^nvme0n1p')
if [[ "$PART_COUNT" -ne 2 ]]; then
    echo "Expected 2 partitions on /dev/nvme0n1, found $PART_COUNT."
    exit 1
fi

echo "All checks passed."

# Now perform install

partprobe ${MY_DISK}

sgdisk -p ${MY_DISK}
cryptsetup luksFormat --type luks2 ${MY_DISK}p2

cryptsetup open ${MY_DISK}p2 ${MY_ROOT}

mkfs.vfat -F32 -n EFI ${MY_DISK}p1

mkfs.btrfs -f -L ${MY_ROOT} /dev/mapper/${MY_ROOT}

mount /dev/mapper/${MY_ROOT} /mnt

btrfs subvolume create /mnt/@
btrfs subvolume create /mnt/@home
btrfs subvolume create /mnt/@root
btrfs subvolume create /mnt/@cache
btrfs subvolume create /mnt/@log
btrfs subvolume create /mnt/@libvirt

btrfs subvolume list /mnt

umount /mnt

mount -t btrfs -o subvol=@,compress-force=zstd:1 -m /dev/mapper/${MY_ROOT} /mnt
mount -t btrfs -o subvol=@home,compress-force=zstd:1 -m /dev/mapper/${MY_ROOT} /mnt/home
mount -t btrfs -o subvol=@root,compress-force=zstd:1 -m /dev/mapper/${MY_ROOT} /mnt/root
mount -t btrfs -o subvol=@cache,compress-force=zstd:1 -m /dev/mapper/${MY_ROOT} /mnt/var/cache
mount -t btrfs -o subvol=@log,compress-force=zstd:1 -m /dev/mapper/${MY_ROOT} /mnt/var/log
mount -t btrfs -o subvol=@libvirt,compress-force=zstd:1 -m /dev/mapper/${MY_ROOT} /mnt/var/libvirt

mount -m ${MY_DISK}p1 /mnt/efi

reflector --country GB --age 24 --protocol http,https --sort rate --save /etc/pacman.d/mirrorlist

pacstrap -K /mnt base base-devel linux linux-firmware intel-ucode vim nano nvim cryptsetup btrfs-progs dosfstools util-linux git unzip sbctl networkmanager sudo

genfstab -U /mnt >> /mnt/etc/fstab
cat /mnt/etc/fstab

systemd-firstboot --root /mnt --prompt

arch-chroot /mnt locale-gen

arch-chroot /mnt groupadd sudo
arch-chroot /mnt useradd -G sudo -m h

arch-chroot /mnt passwd h
arch-chroot /mnt passwd root

arch-chroot /mnt visudo

export MY_UUID=$(blkid ${MY_DISK}p2 | sed -n 's/.*UUID="\([^"]*\)".*/\1/p')
echo $MY_UUID

mkdir /mnt/etc/cmdline.d
echo "rd.luks.name=${MY_UUID}=${MY_ROOT} root=/dev/mapper/${MY_ROOT} rootfstype=btrfs rootflags=subvol=/@ rw" > /mnt/etc/cmdline.d/root.conf

vim /mnt/etc/mkinitcpio.conf
vim /mnt/etc/mkinitcpio.d/linux.preset

mkdir -p /mnt/efi/EFI/Linux
arch-chroot /mnt mkinitcpio -P

objdump -s -j .cmdline /mnt/efi/EFI/Linux/arch-linux.efi
ls -lR /mnt/efi

systemctl --root /mnt enable systemd-resolved systemd-timesyncd NetworkManager
systemctl --root /mnt mask systemd-networkd

arch-chroot /mnt bootctl install --esp-path=/efi
ls -lR /mnt/efi

sync

